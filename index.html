<!doctype html>
<html lang="en-US">
<title>Private Box</title>
	<head>
		<style>
	body {
		background-color: #EEEEEE;
	}
	
	.client {
		background-color: #EEEEEE;
	}
	
	input:invalid, textarea:invalid {
		background-color: #FFFFFF;
	}
</style>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<script type="text/javascript" src="https://download.playfab.com/PlayFabClientApi.js"></script>
  </head>
  
<body style="background-color:#EEEEEE;">
	
    <div id="login" class="login container mb-4" style="background-color:#EEEEEE;">
        <div class="card m-2">
            <div class="card-header">Enter your Username</div>
            <div class="card-body">
                <form novalidate>
                        <input type="Username" class="form-control" id="username" placeholder="Username" required autocomplete="Username">
                    </div>
					<center>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary" onclick="play()">Login</button>
                    </div>
					</center>
                </form>
            </div>
        </div>
    </div>


<center><div id="game" style="display:none;background-color:#EEEEEE;">
    <div class="client container hide">
        <canvas id="stage" width="850" height="480"></canvas>
        <div class="input-group">
            <input id="chat-message" type="text" class="form-control" maxlength="48">
            <span class="input-group-btn"><button class="btn btn-primary chat-btn">Send</button></span>
        </div>
</div></center>

    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

    <!-- Frameworks -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
    <script src="https://code.createjs.com/1.0.0/createjs.min.js"></script>

    <!-- Box Critters -->
    <script>
(function ($) {

    $.fn.addCard = function (name, text) {
        var card = $('<div class="card mb-4"></div>').addClass(name);
        var head = $('<div class="card-header"><div>').text(name).appendTo(card);
        var body = $('<div class="card-body"></div>').text(text).appendTo(card);
        var body = $('<div class="card-footer" style="display:none"></div>').appendTo(card);
        this.append(card);
        return this;
    };

    $.fn.addMenu = function (menu) {
        var html = $('<div class="menu"></div>');
        for (var n = 0; n < menu.length; n++) {
            let option = menu[n];
            var button = $('<button class="btn btn-primary m-1"></button>')
                .text(option.text)
                .appendTo(html);
            if (option.action) {
                button.click(function () {
                    socket.emit(option.action, option.data);
                });
            }
        }
        this.append(html);
        return this;
    };

    $.fn.addAlert = function (name, message, style) {
        var html = $('<div class="alert m-2"></div>')
            .addClass('alert-' + style)
            .html('<strong>' + name + ':</strong> ' + message);
        this.append(html);
        return this;
    };

    $.fn.feedback = function (message) {
        if (message) {
            this.addClass('is-invalid').next('.invalid-feedback').text(message);
        } else {
            this.removeClass('is-invalid');
        }
        return this;
    }

    $.fn.replaceText = function (searchvalue, newvalue) {
        var text = this.text();
        if (text !== undefined) {
            this.text(text.replace(searchvalue, newvalue));
        }
        return this;
    }

}(jQuery));

	</script>
	
    <script>
// Errors
var errorMessages = {
    nickname: 'Nicknames must be between 3 and 25 characters',
    email: 'Invalid email address',
    password: 'Usernames must be between 6 and 100 characters'
};

$('#loginEmail').focus();


$('.goto-lost').click(function () {
    $('.login').hide();
    $('.lost').show();
    $('.lost .form').show();
    $('.lost .success').hide();
    $('#lostEmail').focus();
});

$('.goto-join').click(function () {
    $('.login').hide();
    $('.join').show();
    $('#joinNickname').focus();
});

$('.goto-login').click(function () {
    $('.lost').hide();
    $('.join').hide();
    $('.login').show();
    $('#loginEmail').focus();
});

$(".login form").submit(function (e) {

    e.preventDefault();

    var username = $('#username').val();

    var isValid = true;

    if (username.length < 4 || username.length > 32) {
        $('#username').feedback(errorMessages.nickname).focus();
        isValid = false;
    } else {
        $('#username').feedback();
    }

    if (isValid) {
		loginSession(username);
    }

});

var handleLogin = function (result, error) {
    if (result !== null) {
        console.log(result);
        //gtag('event', 'login');
        $('.login').hide();
        loginSession(result.data.SessionTicket);
    } else if (error !== null) {
        console.error(error);
        $('.login .form-error').text(error.errorMessage).show();

        if (error.error == 'AccountNotFound') {
            $('#loginEmail').feedback('User not found').focus();
        }

        if (error.error == 'InvalidEmailOrPassword') {
            $('#loginEmail').feedback('Invalid email address').focus();
            $('#loginPassword').feedback('Invalid password');
        }
    }
}


$('.lost form').submit(function (e) {

    e.preventDefault();

    var email = $('#lostEmail').val();
    var isValid = true;

    if (!checkEmail(email)) {
        $('#lostEmail').feedback(errorMessages.email).focus();
        isValid = false;
    } else {
        $('#lostEmail').feedback();
    }

    if (isValid) {
        PlayFabClientSDK.SendAccountRecoveryEmail({
            TitleId: PlayFab.settings.titleId,
            Email: email
        }, handleLostPassord);
    }

});

function handleLostPassord(result, error) {
    if (result !== null) {

        var email = result.Request.Email;
        console.log(result);
        $('.lost .form').hide();
        $('.lost .success').show();
        $('.lost .success .card-text').replaceText('{{email}}', email);

    } else if (error !== null) {
        console.error(error);
        $('.lost .form-error').text(error.errorMessage).show();

        if (error.error == 'AccountNotFound') {
            $('#lostEmail').feedback('User not found').focus();
        }
    }
}


$('.join form').submit(function (e) {

    e.preventDefault();

    var nickname = $('#joinNickname').val();
    var email = $('#joinEmail').val();
    var password = $('#joinPassword').val();

    var isValid = true;

    if (password.length < 6 || password.length > 100) {
        $('#joinPassword').feedback(errorMessages.password).focus();
        isValid = false;
    } else {
        $('#joinPassword').feedback();
    }

    if (!checkEmail(email)) {
        $('#joinEmail').feedback(errorMessages.email).focus();
        isValid = false;
    } else {
        $('#joinEmail').feedback();
    }

    if (nickname.length < 3 || nickname.length > 25) {
        $('#joinNickname').feedback(errorMessages.nickname).focus();
        isValid = false;
    } else {
        $('#joinNickname').feedback();
    }

    if (isValid) {
        PlayFabClientSDK.RegisterPlayFabUser({
            TitleId: PlayFab.settings.titleId,
            DisplayName: nickname,
            Email: email,
            Password: password,
            RequireBothUsernameAndEmail: false
        }, handleJoin);
    }
});

var handleJoin = function (result, error) {

    if (result !== null) {
        console.log(result);
        $('.join').hide();
        loginSession(result.data.SessionTicket);
    } else if (error !== null) {
        console.error(error);

        if (error.error == 'InvalidParams') {
            $('.join .form-error').text(error.errorMessage).show();
            $('#joinPassword').feedback(errorMessages.password).focus();
        }

        if (error.error == 'EmailAddressNotAvailable') {
            $('.join .form-error').text(error.errorMessage).show();
            $('#joinEmail').feedback('Email address is not available').focus();
        } else {
            $('#joinNickname').addClass('is-valid');
        }

        if (error.error == 'NameNotAvailable') {
            $('.join .form-error').text('Nickname is not available').show();
            $('#joinNickname').feedback('Nickname is not available').focus();
        }

    }

}

function checkEmail(email) {

    var filter = /^([a-zA-Z0-9_\.\-\+])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;

    if (!filter.test(email)) {
        return false;
    } else {
        return true;
    }

}

	</script>
    <script>
function Artwork(t) {
    this.background, this.foreground, this.character = this.createCharacterSprite(t.character), t.roomPath ? this.roomPath = t.roomPath : this.roomPath = "media/rooms/", this.ring = new createjs.Shape, this.ring.graphics.f().s("#3399FF").ss(2).de(0, 0, 32, 22), this.ring.regX = 16, this.ring.regY = 11, this.shadow = new createjs.Shape, this.shadow.graphics.f("rgba(0,0,0,0.2)").s().de(0, 0, 28, 18), this.shadow.regX = 14, this.shadow.regY = 9, this.crosshair = new createjs.Shape, this.crosshair.graphics.setStrokeStyle(1).beginStroke("black").moveTo(-10, 0).lineTo(10, 0).moveTo(0, -10).lineTo(0, 10)
}

function calculateDistance(t, o, e, r) {
    var a = e - t,
        i = r - o;
    return Math.sqrt(a * a + i * i)
}

function calculateAngle(t, o, e, r) {
    var a = e - t,
        i = o - r,
        n = Math.atan2(a, i),
        s = Math.floor(180 * n / Math.PI);
    return s < 0 ? s + 360 : s
}

function findDirection(t) {
    var o = Math.floor((t + 22.5) / 45);
    return 7 < o ? 0 : o
}

function Events() {}

function Player() {
    this.isMoving = !1, this.hasFrames = !1, this.character, this.nickname, this.balloon, this.direction = 0, this.animation = "none", this.speed = 5, createjs.Container.call(this)
}
Artwork.prototype.createCharacterSprite = function(t) {
    var o = new createjs.SpriteSheet({
            images: t.images,
            frames: t.frames,
            animations: t.animations
        }),
        e = new createjs.Sprite(o, "stand4");
    return e.scaleX = t.scaleX, e.scaleY = t.scaleY, e.regX = t.regX, e.regY = t.regY, e.framerate = t.framerate, e.balloonX = t.balloonX, e.balloonY = t.balloonY, e
}, Player.prototype = Object.create(createjs.Container.prototype), Player.prototype.setCharacter = function(t) {
    "function" == typeof(this.character = t).gotoAndPlay && (this.hasFrames = !0)
}, Player.prototype.updateDirection = function(t) {
    this.direction = t
}, Player.prototype.updateRotation = function(t) {
    this.character.rotation = t
}, Player.prototype.updateAnimation = function(t) {
    void 0 !== t && (this.animation = t), this.hasFrames && (this.isMoving ? this.character.gotoAndPlay("walk" + this.direction) : this.character.gotoAndPlay("stand" + this.direction))
};
var dpr = window.devicePixelRatio;

function Room(t, o, e) {
    if (this.stage = t, this.artwork = o, this.room = new createjs.Container, this.game = new createjs.Container, this.balloons = new createjs.Container, this.nicknames = new createjs.Container, this.game.addEventListener("tick", function(t) {
            t.target.children.sort(sortDepth)
        }), e.artwork && e.artwork.sprites && (console.log(e.artwork.sprites.images[0]), e.artwork.sprites.images[0] = this.artwork.roomPath + e.artwork.sprites.images[0], this.spritesheet = new createjs.SpriteSheet(e.artwork.sprites)), this.playerlist = {}, e.artwork && void 0 !== e.artwork.background) {
        console.log("Add Background:", e.artwork.background);
        var r = new createjs.Bitmap(this.artwork.roomPath + e.artwork.background);
        this.room.addChild(r)
    }
    if (this.room.addChild(this.game), e.artwork && void 0 !== e.artwork.foreground) {
        console.log("Add Foreground:", e.artwork.foreground);
        var a = new createjs.Bitmap(this.artwork.roomPath + e.artwork.foreground);
        this.room.addChild(a)
    }
    if (this.room.addChild(this.nicknames), this.room.addChild(this.balloons), e.artwork && void 0 !== e.artwork.props)
        for (var i = 0; i < e.artwork.props.length; i++) {
            var n = e.artwork.props[i],
                s = new createjs.Sprite(this.spritesheet);
            s.gotoAndStop(n[0]), s.x = n[1], s.y = n[2], this.game.addChild(s)
        }
    if (this.room.addChild(this.edit), this.stage.addChild(this.room), this.stage.update(), null != e.playerlist)
        for (i = 0; i < e.playerlist.length; i++) this.addPlayer(e.playerlist[i], this.useDirection)
}

function sortDepth(t, o) {
    return t.y - o.y
}

function createBalloon(t, o) {
    var e = o + 20,
        r = t + 20,
        a = new createjs.Shape;
    return a.graphics.setStrokeStyle(1).beginStroke("#888888").beginFill("#FFFFFF"), a.graphics.moveTo(5, 0).arcTo(r, 0, r, 5, 5).arcTo(r, e, r - 5, e, 5).lineTo(80, e).lineTo(70, e + 10).lineTo(70, e).arcTo(0, e, 0, e - 5, 5).arcTo(0, 0, 5, 0, 5), a.x = 0 - r / 2, a.y = -10, a
}

function World(r, t, o) {
    var e = this;
    this.socket = r, this.artwork = new Artwork(t), this.room = void 0, this.events = new Events(r, e, void 0), this.stage = new createjs.Stage(o), this.stage.on("stagemousedown", function(t) {
        var o = Math.floor(t.stageX),
            e = Math.floor(t.stageY);
        r.emit("click", {
            x: o,
            y: e
        })
    }), createjs.Ticker.framerate = 60, createjs.Ticker.on("tick", function(t) {
        e.stage.update(t)
    }), void 0 !== r && this.socketHandler(r)
}
Room.prototype.sortDepth = function() {
    this.game.children.sort(sortDepth)
}, Room.prototype.addPlayer = function(t) {
    var o = t.i;
    if (null == this.playerlist[o]) {
        var e = new Player;
        if (e.balloonX = this.artwork.character.balloonX, e.balloonY = this.artwork.character.balloonY, t.c && this.artwork.characters[t.c]) var r = this.artwork.characters[t.c].clone();
        else r = this.artwork.character.clone();
        this.artwork.shadow && e.addChild(this.artwork.shadow.clone()), this.artwork.ring, e.addChild(r), this.artwork.crosshair, void 0 !== t.s && 0 < t.s && (e.speed = t.s), e.x = t.x, e.y = t.y, e.setCharacter(r), this.game.addChild(e);
        var a = new createjs.Container;
        a.x = t.x, a.y = t.y, e.balloon = a, this.balloons.addChild(a);
        var i = new createjs.Container;
        i.x = t.x, i.y = t.y;
        var n = new createjs.Text(t.n, "12px Arial", "#000000");
        n.textAlign = "center", n.lineWidth = 100, n.y = 15, i.addChild(n), e.nickname = i, this.nicknames.addChild(i), this.stage.update(), this.playerlist[o] = e
    }
}, Room.prototype.addBalloon = function(t) {
    var o = this.playerlist[t.i],
        e = new createjs.Container,
        r = new createjs.Text(t.m, "12px Arial", "#000000");
    r.textAlign = "center", r.lineWidth = 100;
    var a = r.getBounds(),
        i = createBalloon(100, a.height);
    e.addChild(i, r), e.y = 0 - a.height - o.balloonY, o.balloon.addChild(e);
    var n = this;
    setTimeout(function() {
        o.balloon.removeChild(e), n.stage.update()
    }, 5e3), this.stage.update()
}, Room.prototype.removePlayer = function(t) {
    console.log("removePlayer", t), console.log(this.playerlist);
    var o = this.playerlist[t.i];
    this.game.removeChild(o), this.balloons.removeChild(o.balloon), this.nicknames.removeChild(o.nickname), delete this.playerlist[t.i], this.stage.update(), console.log(this.playerlist)
}, Room.prototype.movePlayer = function(t) {
    var o = this.playerlist[t.i];
    o.isMoving = !0;
    var e = findDirection(t.r);
    o.updateDirection(e), o.updateAnimation("walk");
    var r = calculateDistance(o.x, o.y, t.x, t.y) * o.speed;
    o.tween = createjs.Tween.get(o, {
        override: !0
    }).to({
        x: t.x,
        y: t.y
    }, r, createjs.Ease.linear).call(function() {
        this.isMoving = !1, o.updateAnimation("stand"), o.nickname.x = o.x, o.nickname.y = o.y, o.balloon.x = o.x, o.balloon.y = o.y
    }).addEventListener("change", function() {
        o.nickname.x = o.x, o.nickname.y = o.y, o.balloon.x = o.x, o.balloon.y = o.y
    }), this.stage.update()
}, World.prototype.setStage = function(t) {
    this.stage = new createjs.Stage(t)
}, World.prototype.socketHandler = function(o) {
    var e = this;
    o.on("connect", function() {}), o.on("disconnect", function() {
        console.log("DISCONNECT")
    }), o.on("login", function(t) {
        console.log("login", t), o.emit("joinRoom", {
            roomId: "tavern"
        })
    }), o.on("joinRoom", function(t) {
        console.log("joinRoom", t), e.createRoom(t, !1)
    }), o.on("A", function(t) {
        console.info("A", t), e.room.addPlayer(t)
    }), o.on("R", function(t) {
        console.info("R", t), e.room.removePlayer(t)
    }), o.on("P", function(t) {
        console.info("P", t), e.room.movePlayer(t)
    }), o.on("M", function(t) {
        console.info("M", t), e.room.addBalloon(t)
    })
}, World.prototype.login = function(t) {
    console.log("login", t), this.socket.open(), this.socket.emit("login", {
		username: t,
        ticket: 'KJ82IqhwIu28'
    })
}, World.prototype.sendMessage = function(t) {
    console.log("sendMessage", t), this.socket.emit("sendMessage", {
        message: t
    })
}, World.prototype.createRoom = function(t) {
    console.log("createRoom", t), this.room = new Room(this.stage, this.artwork, t, !1)
};
	</script>
	
    <script>
var hamster_data = {
    images: ["./media/critters/hamster.png"],
    frames: [[2, 2, 90, 120], [92, 2, 90, 120], [182, 2, 90, 120], [272, 2, 90, 120], [362, 2, 90, 120],
                 [2, 122, 90, 120], [92, 122, 90, 120], [182, 122, 90, 120], [272, 122, 90, 120], [362, 122, 90, 120],
                 [2, 242, 90, 120], [92, 242, 90, 120], [182, 242, 90, 120], [272, 242, 90, 120], [362, 242, 90, 120],
                 [2, 362, 90, 120], [92, 362, 90, 120], [182, 362, 90, 120], [272, 362, 90, 120], [362, 362, 90, 120],
                 [2, 482, 90, 120], [92, 482, 90, 120], [182, 482, 90, 120], [272, 482, 90, 120], [362, 482, 90, 120],
                 [2, 602, 90, 120], [92, 602, 90, 120], [182, 602, 90, 120], [272, 602, 90, 120], [362, 602, 90, 120]],
    animations: {
        "stand4": [0],
        "stand5": [5],
        "stand6": [5],
        "stand7": [10],
        "stand0": [15],
        "stand1": [20],
        "stand2": [25],
        "stand3": [25],
        "walk4": [0, 4],
        "walk5": [5, 9],
        "walk6": [5, 9],
        "walk7": [10, 14],
        "walk0": [15, 19],
        "walk1": [20, 24],
        "walk2": [25, 29],
        "walk3": [25, 29]
    },

    scaleX: .5,
    scaleY: .5,
    regX: 45,
    regY: 100,
    framerate: 24,
    balloonY: 60,
    balloonX: 0
};

var settings = {
    character: hamster_data,
    roomPath: './media/rooms/'
};
	</script>
	
</div>
    <script>
        PlayFab.settings.titleId = "5417";

        var socket = io('wss://boxcritters.org', { //https://boxcritters.herokuapp.com
            autoConnect: false,
            transports: ['websocket']
        });

        hamster_data.images = ['./media/critters/hamster.png'];

        var settings = {
            character: hamster_data,
            roomPath: './media/rooms/'
        }

        var world = new World(socket, settings, 'stage');

        function loginSession(ticket) {
            world.login(ticket);
        }

        socket.on('login', function(data) {

            $('.login').hide();
            $('.client').show();

            $('.client .chat-btn').click(sendMessage);

            $(document).unbind('keypress');
            $(document).keypress(handleKeypress);

            window.onresize = function() {
                var body = $('#stage').parent();
                $('#stage').width(body.width()).height(body.width() * .54);
            }
            window.onresize();
        });

        function handleKeypress(e) {
            if (e.which == 13) {
                sendMessage();
            }
        }

        function sendMessage() {
            var message = $('#chat-message').val();
            if (message.length > 0) {
                world.sendMessage(message);
                $('#chat-message').val('');
                $('#chat-message').focus();
            } else {
                $('#chat-message').focus();
            }
        }

    </script>

    <!-- END --></div></div>
	</body>
	
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-130238613-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-130238613-2');
</script>

<script>
function play() {
	game.style.display = 'inline-block';
	login.style.display = 'none';	
}
</script>
</body>
</html>
